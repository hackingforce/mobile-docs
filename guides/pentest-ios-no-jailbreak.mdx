import { Canary } from '@/components/ui/canary-icon'

export const metadata = {
  title: 'Guia: Pentest iOS sem Jailbreak'
}

# Pentest iOS sem Jailbreak <Canary className='inline-flex size-8 text-[hsla(0,0%,53%,1)]' style={{ width: '0.85em', height: '0.85em' }} />

> [!CANARY]
> Essa é uma versão inicial, e pode conter erros ou informações desatualizadas. O conteúdo está em desenvolvimento e será atualizado conforme necessário.

Assim como o root em dispositivos Android, o jailbreak é um processo que remove as restrições impostas pelo fabricante em dispositivos iOS, permitindo acesso e instalação de aplicativos não autorizados.

Alguns aplicativos não possuem compatibilidade com versões do iOS < 17. Felizmente, existe uma maneira de realizar testes de segurança em dispositivos iOS sem a necessidade de jailbreak.

## Pré-requisitos
- macOS 14 ou posterior
- iPhone com jailbreak (Opcional se possuir o `.ipa` descriptografado)

## Privilégios de Debug
Durante o desenvolvimento de aplicativos no [Xcode](https://developer.apple.com/xcode/), é comum utilizar _breakpoints_ para inspecionar variáveis, avaliar expressões e analisar o comportamento do código em tempo real. Para que isso funcione, o Xcode precisa acessar a memória do processo em execução, e só é possível quando o aplicativo possui o privilégio [`get_task_allow`](https://developer.apple.com/library/archive/technotes/tn2415/_index.html#:~:text=and%20UIPasteboard%20sharing.-,get%2Dtask%2Dallow,-The%20boolean%20value) habilitado.

{/* Se observarmos como um jailbreak funciona, notará que uma das primeiras ações realizadas é executar `task_for_pid(mach_task_self(), 0, &kernel_task);`, onde `kernel_task(0)` — permitindo, assim, acesso direto à memória do kernel. */}

A partir disso, é possível abusar desse privilégio para instrumentar aplicativos em execução. É necessário fazer um _patch_ no aplicativo para habilitar o `get_task_allow`.

## Apple FairPlay DRM
Apple criptografa seus arquivos `.ipa` com uma forma de Gerenciamento de Direitos Digitais (DRM), chamada [FairPlay](https://en.wikipedia.org/wiki/FairPlay). Quando você baixa um aplicativo da App Store, recebe uma versão do aplicativo que está criptografada com uma chave vinculada ao seu ID Apple, garantindo que ele só possa ser descriptografado e executado nesse ambiente específico.

Nem tudo são flores, ao assinar o aplicativo novamente, você quebra a assinatura digital do aplicativo. Isso significa que o aplicativo não poderá ser instalado diretamente no dispositivo, pois o iOS não permitirá a execução de aplicativos com assinatura inválida.

Por tanto, precisamos do aplicativo descriptografado para poder fazer o _patch_ e assinar novamente. O processo de descriptografar o aplicativo é simples, mas requer um dispositivo iOS com jailbreak.

## Adquirindo o Aplicativo

> [!INFO]
> Durante a realização de um pentest, solicite ao cliente o aplicativo descriptografado. Se você já possui o arquivo, pode seguir diretamente para a próxima seção.

Para adquirir o `.ipa` usar o [Apple Configurator](https://apps.apple.com/pt/app/apple-configurator/id1037126344?mt=12), disponivel na App Store do macOS.

![Apple Configurator](/img/guides/pentest-ios-no-jailbreak/apple-config-apps.png)

No terminal, podemos navegar até o diretório onde o `.ipa` foi baixado com o seguinte comando:

```bash
cd ~/Library/Group\ Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/
```

Infelizmente, o modo de desenvolvedor só é visível quando o dispositivo é conectado pela primeira vez no Xcode. Para habilitar o modo desenvolvedor no iPhone, siga os passos abaixo:

![Criando projeto no xcode](/img/guides/pentest-ios-no-jailbreak/new-xcode-project.png)

## Reassinando o aplicativo
Com o `.ipa` descriptografado em mãos, só falta assinar o aplicativo com o privilégio `get_task_allow` habilitado e instalar no iPhone. Editar o arquivo `entitlements.plist` e adicionar o seguinte conteúdo:

```xml showLineNumbers {5,6} filename="entitlements.plist"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>get-task-allow</key>
    <true/>
  </dict>
</plist>
```

Podemos assinar o aplicativo com o `codesign` e o arquivo modificado anteriormente

```bash
codesign -f -s --entitlements entitlements.plist /path/to/app
```

## Hooking
Agora que o aplicativo está assinado e instalado no iOS [18.4.1](https://support.apple.com/en-us/122282), é possível usar o [Frida](https://github.com/frida/frida) ou [Objection](https://github.com/sensepost/objection) para fazer o hooking.

```bash
objection -g com.supersecure.app explore
```

Como resultado, você verá uma tela semelhante a esta:

## Unable to connect to the frida server: need Gadget to attach on jailed iOS

Para resolver esse problema, é necessário baixar o Frida Gadget e colocá-lo no diretório `~/.cache/frida`. Abaixo estão os passos para baixar e configurar o Frida Gadget:

```bash
frida --version
```
versão utilizada do frida: 16.4.10 

[frida-gadget-16.4.10-ios-universal.dylib.gz](https://github.com/frida/frida/releases/download/16.4.10/frida-gadget-16.4.10-ios-universal.dylib.gz)

```bash
mkdir -p ~/.cache/frida
cp frida-gadget-16.4.10-ios-universal.dylib ~/.cache/frida/gadget-ios.dylib
```